#!/usr/bin/python
#
# Copyright I.T. Dev Ltd 2014
# http://www.itdev.co.uk
#


import sys
import argparse

sys.path.insert(0, '/usr/lib')
from mcvirt.mcvirt import McVirt
from mcvirt.virtual_machine.virtual_machine import VirtualMachine
from mcvirt.virtual_machine.hard_drive import HardDrive
from mcvirt.virtual_machine.disk_drive import DiskDrive
from mcvirt.virtual_machine.network_adapter import NetworkAdapter

if __name__ == "__main__":

  parent_parser = argparse.ArgumentParser(add_help = False)
  parent_parser.add_argument('vm_name', metavar = 'VM Name', type = str, help = 'Name of VM')

  # Create an argument parser object
  parser = argparse.ArgumentParser(description = 'Manage the McVirt host')
  subparsers = parser.add_subparsers(dest = 'action', metavar = 'Action', help = 'Action to perform on VM')

  # Add arguments for starting a VM
  start_parser = subparsers.add_parser('start', help = 'Start VM help', parents = [parent_parser])
  start_parser.add_argument('--iso', metavar = 'ISO Path', type = str, help = 'Path of ISO to attach to VM')

  # Add arguments for stopping a VM
  stop_parser = subparsers.add_parser('stop', help = 'Stop VM help', parents = [parent_parser])

  # Add arguments for creating a VM
  create_parser = subparsers.add_parser('create', help = 'Create VM help', parents = [parent_parser])
  create_parser.add_argument('--memory', dest = 'memory', metavar = 'Memory', type = int,
    help = 'Amount of memory to allocate to the VM (MB)', required = True)
  create_parser.add_argument('--disk-size', dest = 'disk_size', metavar = 'Disk Size', type = int,
    help = 'Size of disk to be created for the VM (MB)', required = True)
  create_parser.add_argument('--cpu-count', dest = 'cpu_count', metavar = 'CPU Count', type = int,
    help = 'Number of virtual CPU cores to be allocated to the VM', required = True)
  create_parser.add_argument('--network', dest = 'networks', metavar = 'Network Connection', type = str,
    action = 'append', help = 'Name of networks to connect VM to (each network has a separate NIC)')

  # Get arguments for deleting a VM
  delete_parser = subparsers.add_parser('delete', help = 'Delete VM help', parents = [parent_parser])
  delete_parser.add_argument('--remove-data', dest = 'remove_data', help = 'Removes the VM data from the host',
    action = 'store_true')

  # Get arguments for updating a VM
  update_parser = subparsers.add_parser('update', help = 'Update VM help', parents = [parent_parser])
  update_parser.add_argument('--memory', dest = 'memory', metavar = 'Memory', type = int,
    help = 'Amount of memory to allocate to the VM (MB)')
  update_parser.add_argument('--cpu-count', dest = 'cpu_count', metavar = 'CPU Count', type = int,
    help = 'Number of virtual CPU cores to be allocated to the VM')
  update_parser.add_argument('--add-network', dest = 'add_network', metavar = 'Add Network', type = str,
    help = 'Adds a NIC to the VM, connected to the given network')
  update_parser.add_argument('--remove-network', dest = 'remove_network', metavar = 'Remove Network', type = str,
    help = 'Removes a NIC from VM with the given MAC-address (e.g. \'00:00:00:00:00:00)\'')
  update_parser.add_argument('--add-disk', dest = 'add_disk', metavar = 'Add Disk', type = int,
    help = 'Add disk to the VM (size in MB)')
  update_parser.add_argument('--increase-disk', dest = 'increase_disk', metavar = 'Increase Disk', type = int,
    help = 'Increases VM disk by provided amount (MB)')
  update_parser.add_argument('--disk-id', dest = 'disk_id', metavar = 'Disk Id', type = int,
    help = 'The ID of the disk to be increased by')

  # Get an instance of McVirt
  mcvirt_instance = McVirt()

  args = parser.parse_args()
  action = args.action
  vm_name = args.vm_name

  # Perform functions on the VM based on the action passed to the script
  if (action == 'start'):
    vm_object = VirtualMachine(mcvirt_instance.connection, vm_name)

    # If an ISO has been specified, attach it to the VM before booting
    if (args.iso):
      disk_drive_object = DiskDrive(vm_object)
      disk_drive_object.attachISO(args.iso)
    vm_object.start()

  elif (action == 'stop'):
    vm_object = VirtualMachine(mcvirt_instance.connection, vm_name)
    vm_object.stop()

  elif (action == 'create'):
    VirtualMachine.create(mcvirt_instance.connection, vm_name, args.cpu_count,
      args.memory, args.disk_size, args.networks)

  elif (action == 'delete'):
    vm_object = VirtualMachine(mcvirt_instance.connection, vm_name)
    vm_object.delete(args.remove_data)

  elif (action == 'update'):
    vm_object = VirtualMachine(mcvirt_instance.connection, vm_name)
    if (args.memory):
      vm_object.updateRAM(args.memory)
    if (args.cpu_count):
      vm_object.updateCPU(args.cpu_count)
    if (args.remove_network):
      NetworkAdapter.delete(vm_object, args.remove_network)
    if (args.add_network):
      NetworkAdapter.create(vm_object, args.add_network)
    if (args.add_disk):
      HardDrive.create(vm_object, args.add_disk)
    if (args.increase_disk and args.disk_id):
      harddrive_object = HardDrive(vm_object, args.disk_id)
      harddrive_object.increaseSize(args.increase_disk)
